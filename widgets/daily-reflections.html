<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Daily Reflection</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{--fern:#4b6b43;--stone:#7d8c74;--fog:#dce3e8}
body{margin:0;font-family:Montserrat,Arial,sans-serif;background:#fff}
#card{max-width:420px;margin:1.5rem auto;padding:1.4rem;border:2px solid var(--stone);border-radius:12px;box-shadow:0 2px 6px #0002}
#card h2{margin:0 0 .4rem;font-size:1.2rem;color:var(--fern)}
#card .date{margin:.2rem 0 .8rem;font-size:.9rem;color:var(--stone)}
#card blockquote{margin:.4rem 0;padding-left:1em;border-left:4px solid var(--fern);color:#333}
#card .body p{margin:.6rem 0;font-size:1rem;line-height:1.4;color:#333}
#card .dr-quote-src{color:var(--stone);font-size:.9rem;margin:.2rem 0 0}
#card .dr-foot{font-size:.75rem;color:var(--fog);margin-top:1rem;line-height:1.2}
</style>
</head>
<body>
<div id="card"><h2>Loading…</h2></div>
<script type="module">
async function fetchText(){
  const r=await fetch('https://r.jina.ai/http://www.aa.org/daily-reflections',{cache:'no-store'});
  if(!r.ok) throw new Error('fetch');
  return r.text();
}
function parseJinaText(raw){
  raw=raw.replace(/\r/g,'');
  const lines=raw.split('\n');
  let i=0;
  const out={title:'Daily Reflection',date:'',quotes:[],body:''};
  while(i<lines.length && !/^###\s+/.test(lines[i].trim())) i++;
  if(i<lines.length){
    out.title=lines[i].trim().replace(/^###\s*/,'').replace(/^"|"$/g,'').trim();
    i++;
  }
  while(i<lines.length && !lines[i].trim()) i++;
  if(i<lines.length){out.date=lines[i].trim();i++;}
  const rawQuotes=[];
  while(i<lines.length && rawQuotes.length<6){
    const t=lines[i].trim();
    if(!t || !t.startsWith('**')) break;
    rawQuotes.push(t);
    i++;
  }
  const quotes=[],bodyPrepend=[],seen=new Set();
  for(const t of rawQuotes){
    let q=t.replace(/^\*+|\*+$/g,'').trim();
    q=q.replace(/^['"“”‘’]+|['"“”‘’]+$/g,'').trim();
    q=q.replace(/\s+/g,' ');
    const canon=q.toLowerCase().replace(/[^\w.\s]/g,'');
    if(!q || seen.has(canon)) continue;
    seen.add(canon);
    if(q.length>160) bodyPrepend.push(q);
    else if(quotes.length<2) quotes.push(q);
  }
  out.quotes=quotes;
  const foot=[/^\*\s+Left/i,/^\*\s+Right/i,/Plain text via/i,/Make a Contribution/i,/Online Bookstore/i,/Select your language/i];
  const paras=[];let p=[];
  for(;i<lines.length;i++){
    const line=lines[i],t=line.trim();
    if(t===''){if(p.length){paras.push(p.join(' '));p=[];}continue;}
    if(t.startsWith('[')||foot.some(re=>re.test(t))) break;
    p.push(t);
  }
  if(p.length) paras.push(p.join(' '));
  if(bodyPrepend.length) paras.unshift(...bodyPrepend);
  out.body=paras.join('\n\n').trim();
  return out;
}
function render(d){
  const card=document.getElementById('card');
  if(!d) return card.innerHTML='<p>Unable to load today\'s Daily Reflection.</p>';
  let h=`<h2>${d.title}</h2>`;
  if(d.date) h+=`<div class="date">${d.date}</div>`;
  if(d.quotes && d.quotes.length){
    if(d.quotes.length===1){
      h+=`<blockquote><p class="dr-quote">${d.quotes[0]}</p></blockquote>`;
    }else if(d.quotes.length>=2){
      h+=`<blockquote><p class="dr-quote">${d.quotes[0]}</p><p class="dr-quote-src">${d.quotes[1]}</p></blockquote>`;
    }
  }
  if(d.body){
    const ps=d.body.split(/\n\n+/).map(p=>`<p>${p}</p>`).join('');
    h+=`<div class="body">${ps}</div>`;
  }
  h+=`<footer class="dr-foot">From <em>Daily Reflections</em>. Copyright \u00A9 1990 A.A. World Services, Inc. <a href="https://www.aa.org/daily-reflections" target="_blank" rel="noopener">View at AA.org</a></footer>`;
  card.innerHTML=h;
}
window.parseJinaText=parseJinaText;
fetchText().then(t=>render(parseJinaText(t))).catch(()=>render(null));
</script>
</body>
</html>
