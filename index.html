<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>California YPAA Map</title>
  <style>
    html,body {margin:0;height:100%;overflow:hidden}   /* no iframe scroll */
    #map-wrapper {width:100%;height:100%;cursor:grab}
    svg {width:100%;height:100%}
  </style>

  <!-- tiny Panzoom bundle -->
  <script src="https://cdn.jsdelivr.net/npm/@panzoom/panzoom@9.4.0/dist/panzoom.min.js"></script>
</head>

<body>
  <div id="map-wrapper">Loading mapâ€¦</div>

  <script>
    /* ----------  1. fetch and inline the SVG  ---------- */
    fetch('usa-ca-optimized-viewbox.svg')
      .then(r => r.text())
      .then(svgText => {
        document.getElementById('map-wrapper').innerHTML = svgText;

        const svgRoot = document.querySelector('#map-wrapper svg');
        /* remove any embedded XML prolog (just in case) */
        if (svgRoot.previousSibling && svgRoot.previousSibling.nodeType === 3) {
          svgRoot.previousSibling.remove();
        }

        /* ----------  2. Panzoom on the inline <svg> ---------- */
        const pz = panzoom(svgRoot, { smoothScroll:false });

        /* drag-vs-click guard */
        const THRESHOLD = 5;
        let sx=0, sy=0, dragged=false;

        pz.on('panstart', ev => {
          dragged=false;
          sx=ev.detail.origEvt.clientX;
          sy=ev.detail.origEvt.clientY;
        });

        pz.on('pan', ev => {
          const dx=Math.abs(ev.detail.origEvt.clientX - sx);
          const dy=Math.abs(ev.detail.origEvt.clientY - sy);
          if (dx > THRESHOLD || dy > THRESHOLD) dragged=true;
        });

        /* cancel click only after a genuine drag */
        svgRoot.querySelectorAll('a.map-link').forEach(a=>{
          a.addEventListener('click', e=>{
            if (dragged){ e.preventDefault(); dragged=false; }
          }, true);   // capture phase
        });
      })
      .catch(err => {
        document.getElementById('map-wrapper').textContent =
          'Error loading SVG: ' + err;
      });
  </script>
</body>
</html>
