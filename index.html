<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>California YPAA Map</title>
  <style>
    html,body { margin:0; height:100%; overflow:hidden; }
    #map-wrapper { width:100%; height:100%; cursor:grab; }
    svg { width:100%; height:100%; }
  </style>
  <script src="panzoom.min.js"></script>
</head>

<body>
  <div id="map-wrapper">Loading map…</div>

  <script>
    /* ---------- 1. fetch SVG, parse, append ---------- */
    fetch('usa-ca-optimized-viewbox.svg')
      .then(r => r.text())
      .then(svgText => {
        const parser = new DOMParser();
        const svgDoc = parser.parseFromString(svgText, 'image/svg+xml');
        const svgRoot = svgDoc.documentElement;          // <svg …>

        /* 1️⃣  ensure the xlink namespace is present */
        if (!svgRoot.hasAttribute('xmlns:xlink')) {
          svgRoot.setAttribute(
            'xmlns:xlink',
            'http://www.w3.org/1999/xlink'
          );
        }

        /* ---- inject into the page ---- */
        const wrapper = document.getElementById('map-wrapper');
        wrapper.textContent = '';
        wrapper.appendChild(svgRoot);

        /* 2️⃣  Panzoom on the inline SVG (desktop + mobile pinch) */
        const pz = panzoom(svgRoot, { smoothScroll:false });

        const THRESHOLD = 5;
        let dragged=false, sx=0, sy=0;

        pz.on('panstart', e=>{
          dragged=false;
          sx=e.detail.origEvt.clientX;
          sy=e.detail.origEvt.clientY;
        });

        pz.on('pan', e=>{
          const dx=Math.abs(e.detail.origEvt.clientX-sx);
          const dy=Math.abs(e.detail.origEvt.clientY-sy);
          if(dx>THRESHOLD||dy>THRESHOLD) dragged=true;
        });

        /* 3️⃣  add xlink:href if missing, and apply drag-guard */
        svgRoot.querySelectorAll('a.map-link').forEach(a=>{
          const url = a.getAttribute('href');
          if (url && !a.hasAttribute('xlink:href')) {
            a.setAttribute('xlink:href', url);           // mobile needs this
          }
          a.addEventListener('click', ev=>{
            if (dragged){ ev.preventDefault(); dragged=false; }
          }, true);
        });
      })
      .catch(err=>{
        document.getElementById('map-wrapper')
          .textContent = 'Error loading SVG: ' + err;
      });
  </script>
</body>
</html>
